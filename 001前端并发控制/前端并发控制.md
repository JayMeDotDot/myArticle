
# å‰ç«¯çš„å¹¶å‘æ§åˆ¶

å‰ä¸¤å¤©ï¼Œå¤§åœ£è€å¸ˆåœ¨ç¾¤é‡ŒæŠ›å‡ºäº†è¿™ä¹ˆä¸€ä¸ªé—®é¢˜ï¼Œé—®é¢˜å¦‚ä¸‹ï¼š

> è¯·å®ç°å¦‚ä¸‹çš„å‡½æ•°ï¼Œå¯ä»¥æ‰¹é‡è¯·æ±‚æ•°æ®ï¼Œæ‰€æœ‰çš„ URL åœ°å€åœ¨ urls å‚æ•°ä¸­ï¼ŒåŒæ—¶å¯ä»¥é€šè¿‡ max å‚æ•°æ§åˆ¶è¯·æ±‚çš„å¹¶å‘åº¦ï¼Œå½“æ‰€æœ‰è¯·æ±‚ç»“æŸä¹‹åï¼Œéœ€è¦æ‰§è¡Œ callback å›è°ƒå‡½æ•°ã€‚

åœ¨å°è¯•äº†å‡ æ¬¡ä»¥åï¼Œè‡ªå·±ç£•ç£•ç»Šç»Šå‹‰å¼ºç®—æ˜¯å®ç°äº†è¿™ä¸ªå‡½æ•°ã€‚è€Œåï¼Œå¤§åœ£è€å¸ˆåœ¨åŸåŸºç¡€ä¸Šæå‡ºäº†å¦å¤–çš„é—®é¢˜ã€‚æ‰€ä»¥ï¼Œä»Šå¤©å‡†å¤‡ä»å¤´æ•´ç†ä¸€ä¸‹æ€è·¯ï¼Œä»ç®€å•åˆ°å¤æ‚ï¼Œä¾æ¬¡å»å®ç°ã€‚

## é—®é¢˜åˆ†æ
é¦–å…ˆï¼Œé—®é¢˜çš„æ ¹æœ¬æ˜¯ï¼šéœ€è¦æ ¹æ® urls æ¥å‘é€è¯·æ±‚ã€è·å–æ•°æ®ã€è¿›è¡Œå¤„ç†ã€‚
é‚£ä¹ˆï¼Œåœ¨ä¸è€ƒè™‘å¹¶å‘é™åˆ¶çš„æƒ…å†µï¼Œæˆ‘ä»¬å¦‚ä½•å»å®ç°å‘¢ï¼Ÿ
å› ä¸º fetch è¿”å›çš„æ˜¯ä¸€ä¸ª promiseï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Promise.all() å»å¹¶è¡Œæ‰§è¡Œä»»æ„æ•°é‡çš„ promiseï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æŒ‰ç…§å¦‚ä¸‹çš„æ–¹å¼å»åšï¼š

```Javascript
  const urls = [/* è‹¥å¹²ä¸ª URL */]
  let promises = urls.map(url => fetch(url).then(r => r.text()))
  Promise.all(promises).then(bodies => {/* å¤„ç†å¾—åˆ°çš„å­—ç¬¦ä¸²æ•°ç»„ */})
                       .catch(e => console.error(e))
```

è¿™ç§å®ç°æ–¹å¼ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯å¦‚æœ urls å¾ˆé•¿çš„è¯ï¼Œä¸€ç¬é—´çš„å¹¶å‘é‡å°±é«˜çš„å¯æ€•äº†ï¼Œè€Œä¸”å¦‚æœå…¶ä¸­æœ‰è¯·æ±‚å¤±è´¥äº†ï¼Œé‚£ä¹ˆè¿”å›çš„ promise ä¹Ÿå°†ä¼šè¢«æ‹’ç»ã€‚

é’ˆå¯¹ä¸Šé¢ä¸¤ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æœŸçº¦é“¾æ¥è¿›è¡Œæ”¹è¿›ã€‚æˆ‘ä»¬ä¸€æ¬¡åªè¯·æ±‚ä¸€ä¸ª URLã€‚å½“è¯¥è¯·æ±‚è¿”å›çš„æ—¶å€™ï¼Œæˆ‘ä»¬å†è¿›è¡Œä¸‹ä¸€æ¬¡è¯·æ±‚ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é¿å…ç½‘ç»œè¿‡è½½ã€‚

```Javascript
  function fetchSequentially(urls) {
    // ä¿å­˜æŠ“å–åˆ°çš„æ•°æ®
    const bodies = []

    // å¯¹å•ä¸ª URL è¿›è¡Œè¯·æ±‚
    function fetchOne(url) {
      return fetch(url)
                .then(response => response.text())
                .then(body => {
                         // å¯¹æ•°æ®è¿›è¡Œå¤„ç†
                         bodies.push(body)
                       })
    }

    // åˆ›å»ºä¸€ä¸ªç«‹å³å…‘ç°çš„æœŸçº¦ä½œä¸ºæœŸçº¦é“¾çš„å¼€å¤´
    let p = new Promise.resolve(undefined)

    for (url of urls) {
      p = p.then(() => fetchOne(url))
    }

    return p.then(() => bodies)
  }

  fetchSequentially(urls)
      .then(bodies => {/* å¤„ç†è·å–åˆ°çš„æ•°æ® */})
      .catch(e => console.error(e))
```

ä½†æ˜¯è¿™æ ·å­ä¸€ä¸ªä¸€ä¸ªå»è¯·æ±‚ï¼Œåˆå¯¼è‡´è¯·æ±‚æ—¶é—´è¿‡é•¿ï¼Œæ‰€ä»¥è¿™å°±å¼•å‡ºäº†æˆ‘ä»¬ä¸€å¼€å§‹æåˆ°çš„é—®é¢˜ï¼šéœ€è¦ä¸€ä¸ªå‡½æ•°ï¼Œæ—¢èƒ½æ‰¹é‡è¯·æ±‚æ•°æ®ï¼Œåˆå¯ä»¥é€šè¿‡ max å‚æ•°æ¥æ§åˆ¶è¯·æ±‚çš„å¹¶å‘åº¦ã€‚

## å¹¶å‘æ§åˆ¶çš„å®ç°

1. é¦–å…ˆï¼Œæˆ‘ä»¬æ ¹æ®ä¼ å…¥çš„ max æ¥æ§åˆ¶å½“å‰è¯·æ±‚çš„æ•°é‡ï¼Œå½“æ¯å½“å¼€å§‹ä¸€ä¸ªè¯·æ±‚çš„æ—¶å€™ max - 1ï¼Œæ¯å½“ä¸€ä¸ªè¯·æ±‚ç»“æŸçš„æ—¶å€™ max + 1ã€‚
2. è€Œå½“ä¸€ä¸ªè¯·æ±‚ç»“æŸçš„æ—¶å€™ï¼Œè‡ªåŠ¨å‘èµ·å¦ä¸€ä¸ªè¯·æ±‚ã€‚
3. æ¯å½“ä¸€ä¸ªè¯·æ±‚å‘èµ·æ—¶ï¼Œå°±ä» urls ä¸­å–å‡ºä¸€ä¸ª urlï¼Œç›´åˆ° urls ä¸ºç©º

```Javascript
  function sendRequest(urls, max, callback) {
    return new Promise(() => {
      let myFetch = async () => {
        while (max > 0 && urls.length > 0) {
          max--;
          let url = urls.shift()
          fetch(url)
            .then(response => response.text())
            .then(data => {
              callback(data)
              max++;
              myFetch()
            })
        }
      }
      myFetch()
    })
  }

  // æˆ‘ä»¬å¯ä»¥é€šè¿‡æ„é€ ä¸‹é¢ä¾‹å­æ¥éªŒè¯æ˜¯å¦æˆåŠŸæ‰§è¡Œ
  // éœ€è¦æ‰“å¼€å¯¹åº”ç½‘é¡µæ”¾åœ¨é‡Œé¢è·‘
  let urls = Array(10).fill('https://www.baidu.com')
  let fn = (data) => {
    console.log(Date.now())
    // åªæ‰“å°å‰åä¸ªå­—ç¬¦
    console.log(data.slice(0,10))
  }

  sendRequest(urls, 3, fn)
```

å½“è¿™ä¸ªé—®é¢˜è¢«è§£å†³ä»¥åï¼Œå¤§åœ£è€å¸ˆåˆå¯¹è¿™ä¸ªé—®é¢˜è¿›è¡Œäº†æ”¹é€ ï¼šå¦‚æœ urls çš„è¯·æ±‚æœ‰ä¼˜å…ˆçº§çš„è¯ï¼Œåº”è¯¥å¦‚ä½•å»å®ç°ï¼Ÿ
æˆ‘æ€è€ƒäº†ä¸€ä¸‹ï¼Œå¦‚æœä¼ å…¥çš„ urls æ˜¯å›ºå®šçš„ï¼Œé‚£ä¹ˆåªéœ€è¦åœ¨å†…éƒ¨å…ˆå¯¹ urls æŒ‰ç…§ä¼˜å…ˆçº§è¿›è¡Œæ’åºå°±å¥½äº†ã€‚ä½†é—®é¢˜è‚¯å®šä¸å¯èƒ½è¿™ä¹ˆç®€å•ï¼Œè¿™ä¸ª urls åº”è¯¥æ˜¯åŠ¨æ€çš„ï¼Œå½“æˆ‘ä»¬åœ¨æ­£å¸¸è¯·æ±‚ urls æ—¶ï¼Œå¯èƒ½ä¼šæœ‰æ–°çš„ url è¿›æ¥ï¼Œè€Œè¿™ä¸ª url çš„ä¼˜å…ˆçº§ä¼šé«˜äºè¿˜æ²¡è¯·æ±‚å®Œçš„ urlsã€‚è¿™æ—¶ï¼Œå½“å‰åºè¯·æ±‚ç»“æŸæ—¶ï¼Œåç»­è¯·æ±‚éœ€è¦ä¼˜å…ˆå¯¹è¿™ä¸ªä¼˜å…ˆçº§é«˜çš„ url è¿›è¡Œè¯·æ±‚ã€‚

## å¸¦ä¼˜å…ˆçº§çš„å¹¶å‘æ§åˆ¶

ç¾¤é‡Œçš„å°ä¼™ä¼´é©¬ä¸Šå°±ç»™å‡ºäº†ç­”æ¡ˆï¼šç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚æˆ‘ä¸€çœ‹å°±çŸ¥é“ï¼Œé—®é¢˜æ¥äº†ï¼Œå› ä¸ºæˆ‘ä¸ä¼šï¼ğŸ¤¦
é‚£ä¹ˆï¼Œä»€ä¹ˆæ˜¯ä¼˜å…ˆçº§é˜Ÿåˆ—å‘¢ï¼Ÿé¡¾åæ€ä¹‰ï¼Œå®ƒé¦–å…ˆåº”è¯¥æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè€Œå‡ºé˜Ÿé¡ºåºæ˜¯æŒ‰ç…§ä¼˜å…ˆçº§çš„ï¼Œä¼˜å…ˆçº§æœ€é«˜çš„ï¼Œæœ€å…ˆå‡ºé˜Ÿã€‚

å¦‚ä½•å®ç°ä¸€ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—å‘¢ï¼Ÿæœ€ç›´æ¥ã€æœ€é«˜æ•ˆçš„åŠæ³•å°±æ˜¯ç”¨å †æ¥å®ç°ã€‚è¿™æ˜¯å› ä¸ºï¼Œå †å’Œä¼˜å…ˆçº§é˜Ÿåˆ—éå¸¸ç›¸ä¼¼ã€‚ä¸€ä¸ªå †å°±å¯ä»¥çœ‹ä½œä¸€ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚å¾ˆå¤šæ—¶å€™ï¼Œå®ƒä»¬åªæ˜¯æ¦‚å¿µä¸Šçš„åŒºåˆ†è€Œå·²ã€‚å¾€ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼Œå°±ç›¸å½“äºå¾€å †ä¸­æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼›ä»ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­å–å‡ºä¼˜å…ˆçº§æœ€é«˜çš„å…ƒç´ ï¼Œå°±ç›¸å½“äºå–å‡ºå †é¡¶å…ƒç´ ã€‚ä½†æ˜¯ï¼ŒJavaScript ä¸­å¹¶æ²¡æœ‰æä¾›ä¼˜å…ˆçº§é˜Ÿåˆ—çš„å®ç°ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬è‡ªå·±å»å®ç°ä¸€ä¸ªã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—çš„ç±» PriorityQueueï¼Œç„¶åå®ç°æ’å…¥å’Œåˆ é™¤çš„æ“ä½œã€‚

```Javascript
class PriorityQueue {
  constructor(max=10) {
    // ç”¨æ•°ç»„å­˜å‚¨æ•°æ®
    this.queue = [null]
    // è®°å½•é˜Ÿåˆ—ä¸­å·²å­˜åœ¨çš„ä¸ªæ•°
    this.count = 0
    // è®¾ç½®å †å¯ä»¥å­˜å‚¨çš„æœ€å¤§æ•°æ®ä¸ªæ•°
    this.max = max
  }

  // å…¥é˜Ÿæ“ä½œ
  enqueue(element) {
    if (this.count >= this.max) { return -1 }  // é˜Ÿåˆ—å·²æ»¡ï¼Œå…¥é˜Ÿå¤±è´¥
    this.count = this.count + 1
    this.queue[this.count] = element
    let index = this.count
    let tmp = Math.floor(index / 2)
    while (tmp > 0 && this.queue[index].priority > this.queue[tmp].priority) {
      [this.queue[index], this.queue[tmp]] = [this.queue[tmp], this.queue[index]]
      index = tmp
      tmp = Math.floor(index / 2)
    }
  }

  // å‡ºé˜Ÿæ“ä½œ
  dequeue() {
    if (this.count === 0) { return -1 }  // é˜Ÿåˆ—ä¸ºç©ºï¼Œå‡ºé˜Ÿå¤±è´¥
    let element = this.queue[1]
    this.queue[1] = this.queue[this.count]
    delete this.queue[this.count]
    this.count = this.count - 1
    this.heapify(1)
    return element
  }

  // è‡ªä¸Šè€Œä¸‹è¿›è¡Œå †åŒ–
  heapify(index) {
    let maxIndex = index
    while (true) {
      if (index*2 <= this.count && this.queue[maxIndex].priority < this.queue[index*2].priority) { maxIndex = index*2 }
      if (index*2+1 <= this.count && this.queue[maxIndex].priority < this.queue[index*2+1].priority) { maxIndex = index*2+1 }
      if (maxIndex === index) { break }
      [this.queue[index], this.queue[maxIndex]] = [this.queue[maxIndex], this.queue[index]]
      index = maxIndex
    }
  }
}
```

ä¸Šé¢å°±æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚å½“ä¸€ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°ä»¥åï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ä¹‹å‰çš„æ§åˆ¶å¹¶å‘è¯·æ±‚çš„å‡½æ•°è¿›è¡Œä¸€å®šæ”¹é€ ï¼Œå°±å¯ä»¥å®ç°ä¸€ä¸ªä¾æ®ä¼˜å…ˆçº§é˜Ÿåˆ—æ¥æ§åˆ¶å¹¶å‘è¯·æ±‚çš„å‡½æ•°äº†ã€‚

```JavaScript
  function sendRequest(urls, max, callback) {
    return new Promise(() => {
      let myFetch = async () => {
        while (max > 0 && urls.count > 0) {
          max--;
          let url = urls.dequeue()
          console.log(url.priority)
          fetch(url.value)
            .then(response => response.text())
            .then(data => {
              callback(data)
              max++;
              myFetch()
            })
        }
      }
      myFetch()
    })
  }


  let urls = new PriorityQueue()
  urls.enqueue({value: 'https://www.baidu.com', priority: 7})
  urls.enqueue({value: 'https://www.baidu.com', priority: 4})
  urls.enqueue({value: 'https://www.baidu.com', priority: 9})
  urls.enqueue({value: 'https://www.baidu.com', priority: 1})
  urls.enqueue({value: 'https://www.baidu.com', priority: 6})
  urls.enqueue({value: 'https://www.baidu.com', priority: 3})
  urls.enqueue({value: 'https://www.baidu.com', priority: 2})
  urls.enqueue({value: 'https://www.baidu.com', priority: 5})
  urls.enqueue({value: 'https://www.baidu.com', priority: 8})
  urls.enqueue({value: 'https://www.baidu.com', priority: 10})

  let fn = (data) => {
    console.log(Date.now())
    console.log(data.slice(0,10))
  }

  sendRequest(urls, 3, fn)

  urls.enqueue({value: 'https://www.baidu.com', priority: 12})
```

å½“æˆ‘ä»¬æŠŠä»£ç æ”¾è¿›æµè§ˆå™¨ä¸­å»è·‘ï¼Œä¼šå¾—åˆ°å¦‚ä¸‹ç»“æœï¼š

![æµè§ˆå™¨æˆªå›¾.png](æµè§ˆå™¨æˆªå›¾.png)

ä»æˆªå›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåç»­æ·»åŠ çš„ä¼˜å…ˆçº§æœ€é«˜çš„è¯·æ±‚ï¼Œå…ˆè¢«å‘é€äº†ã€‚






## å‚è€ƒèµ„æ–™
  1. ã€ŠJavaScriptæƒå¨æŒ‡å—ã€‹-- David Flanagan
  2. [æ–‡ç« ï¼šå­—èŠ‚è·³åŠ¨é¢è¯•å®˜ï¼Œæˆ‘ä¹Ÿå®ç°äº†å¤§æ–‡ä»¶ä¸Šä¼ å’Œæ–­ç‚¹ç»­ä¼  -- èŠ±æœå±±å¤§åœ£](https://juejin.cn/post/6844904055819468808)
  3. ã€Šæ•°æ®ç»“æ„ä¸ç®—æ³•ä¹‹ç¾ã€‹-- ç‹äº‰
